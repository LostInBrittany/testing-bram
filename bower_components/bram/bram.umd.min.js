(function(c,d){'object'==typeof exports&&'undefined'!=typeof module?module.exports=d():'function'==typeof define&&define.amd?define(d):c.Bram=d()})(this,function(){'use strict';function c(P,Q){return Array.isArray(P)&&!isNaN(+Q)}function d(P){return Array.isArray(P)||'object'==typeof P}function e(P,Q){var R=new Proxy(P,{get:function(S,T){return B.observe(R,T),S[T]},set:function(S,T,U){var V=S[T];// If the value hasn't changed, nothing else to do
return!(!F(U)&&d(U)&&(U=E(U)),S[T]=U,U!==V)||(c(S,T)?Q({prop:D,index:+T,type:'set'},U):Q({prop:T,type:'set'},U),!0)},deleteProperty:function(S,T){return c(S,T)&&Q({prop:D,index:+T,type:'delete'}),!0}});return R}function f(P){return P?Object.keys(P).reduce(function(Q,R){var S=P[R];return Q[R]=Array.isArray(S)||'object'==typeof S?E(S):S,Q},P):P}function g(P,Q){this.model=P,this.parent=Q}function h(P,Q,R){function S(X){if(W++,V===W){var Y=Q[V];Y(X,R,P),V=+U.shift()}return!V}function T(X){var Y,Z=A.call(X.attributes||[]);return(z.call(Z,function(){if(Y=S(X),Y)return!0}),!Y)&&(z.call(X.childNodes,function($){return(Y=S($),!!Y)||(Y=!T($),!!Y)||void 0}),!Y)}var U=Object.keys(Q),V=+U.shift(),W=0;T(P.tree)}function j(){this.values={},this.raw='',this.hasBinding=!1,this.includesNonBindings=!1}function k(P){for(var W,Q=0,R=P.length,S=new j,T=!1,U='',V=0;Q<R;){if(U=W,W=P[Q],!T){if('{'===W){'{'==U&&(S.hasBinding=!0,V=S.raw.length,null!=S.values[V]&&V++,S.values[V]='',T=!0),Q++;continue}else'{'==U&&(S.raw+=U);S.raw+=W}else{if('}'===W){'}'==U&&(T=!1),Q++;continue}S.values[V]+=W}Q++}return S.includesNonBindings=0<S.raw.length,S}function l(P,Q,R,S){var T=Q.compute(P),U=function(){S(T())};Q.props().forEach(function(V){var W=P.readInTransaction(V);W.model,!1!==W.bindable&&W.reads.forEach(function(X){R.on(X[0],X[1],U)})}),U()}function m(P,Q,R){var S={};switch(P.nodeType){// Element
case 1:var T;if('TEMPLATE'===P.nodeName&&(T=n(P))){var U=k(P.getAttribute(T));U.hasBinding&&(U.throwIfMultiple(),S[T]=!0,R[Q.id]=function(W,X,Y){'each'===T?I.each(W,X,U,Y):l(X,U,Y,I[T](W,X,Y))})}break;// TextNode
case 3:var U=k(P.nodeValue);U.hasBinding&&(R[Q.id]=function(W,X,Y){l(X,U,Y,I.text(W))});}y.call(P.attributes||[],function(W){if(Q.id++,!S[W.name]){var X=W.name,Y=p(X),Z=k(W.value);if(Z.hasBinding)R[Q.id]=function(da,ea,fa){return Y?(da.removeAttribute(X),void l(ea,Z,fa,I.prop(da,Y))):void l(ea,Z,fa,I.attr(da,X))};else if(Y)R[Q.id]=function(da){da.removeAttribute(X),I.prop(da,Y)(W.value)};else if('on-'===X.substr(0,3)){var $=X.substr(3);R[Q.id]=function(da,ea,fa){da.removeAttribute(X),I.event(da,$,ea,Z,fa)}}}});var V=P.childNodes;return y.call(V,function(W){Q.id++,m(W,Q,R)}),R}function n(P){var Q;for(var R=0,S=J.length;R<S;R++)if(Q=J[R],P.getAttribute(Q))return Q}function p(P){return P&&':'===P[0]&&P.substr(1)}function q(P){return class extends P{constructor(){super();var Q=this.constructor;let R=Q.template;R&&(this._hydrate=M(R)),this._hasRendered=!1,this.model={};let S=Q.events;S&&!Q._hasSetupEvents&&r(Q);let T=!Q._hasInstalledProps&&Q.observedProperties;T&&(Q._hasInstalledProps=!0,s(Q,T,Q.observedAttributes))}connectedCallback(){if(this._hydrate&&!this._hasRendered){F(this.model)||(this.model=E(this.model));var Q=new g(this).add(this.model);this._link=this._hydrate(Q);var R=this._link.tree,S=this.constructor.renderMode;'light'===S?this.appendChild(R):(this.attachShadow({mode:'open'}),this.shadowRoot.appendChild(R)),this._hasRendered=!0}else this._hasRendered&&this._link.attach();this.childrenConnectedCallback&&(this._disconnectChildMO=u(this))}disconnectedCallback(){this._disconnectChildMO&&this._disconnectChildMO(),this._link&&this._link.detach()}attributeChangedCallback(Q,R,S){var T=this.constructor._syncedAttrs,U=T&&T[Q];U&&this[Q]!==S&&(this[Q]=S)}}}function r(P){P._hasSetupEvents=!0,P.events.forEach(function(Q){Object.defineProperty(P.prototype,'on'+Q,{get:function(){return this['_on'+Q]},set:function(R){var S='_on'+Q,T=this[S];T&&this.removeEventListener(Q,T),this[S]=R,this.addEventListener(Q,R)}})})}function s(P,Q,R=[]){P._syncedAttrs={};var S=P.prototype;Q.forEach(function(T){var U=Object.getOwnPropertyDescriptor(S,T);if(!U){var V=-1!==R.indexOf(T);V&&(P._syncedAttrs[T]=!0),Object.defineProperty(S,T,{get:function(){return this.model[T]},set:function(W){if(this.model[T]=W,V){var X=this.getAttribute(T);'boolean'==typeof W?W&&''!==X?this.setAttribute(T,''):''===X&&!W&&this.removeAttribute(T):X!==W&&this.setAttribute(T,W)}}})}})}function u(P){var Q=!1,R=function(){Q||P.childrenConnectedCallback()};if(!O)return void x(R);var S=new MutationObserver(R);return S.observe(P,{childList:!0}),P.childNodes.length&&x(R),function(){Q=!0,S.disconnect()}}var v='function'==typeof Symbol?Symbol:function(P){return'@@-'+P},w=Object.values||function(P){return Object.keys(P).reduce(function(Q,R){return Q.push(P[R]),Q},[])},x='function'==typeof Promise?P=>Promise.resolve().then(P):P=>setTimeout(()=>P(),0),y=Array.prototype.forEach,z=Array.prototype.some,A=Array.prototype.slice;class B{static add(P){this.current=P,this.stack.push(P)}static remove(){this.stack.pop(),this.current=this.stack[this.stack.length-1]}static observe(P,Q){this.current&&this.current.stack.push([P,Q])}constructor(){this.stack=[]}start(){B.add(this)}stop(){return B.remove(),this.stack}}B.stack=[];var C=v('bram-events'),D=v('bram-array-change'),E=function(P,Q){return F(P)?P:(P=f(P,Q)||{},Object.defineProperty(P,C,{value:{},enumerable:!1}),e(P,function(R,S){var T=P[C][R.prop];T&&T.forEach(function(U){U(R,S)})}))},F=function(P){return P&&!!P[C]},G=function(P,Q,R){var S=P[C];if(S){var T=S[Q];T||(T=S[Q]=[]),T.push(R)}},H=function(P,Q,R){var S=P[C];if(S){var T=S[Q];if(T){var U=T.indexOf(R);-1===U||(T.splice(U,1),!T.length&&delete S[Q])}}};g.prototype.read=function(P){return this._read(P)||{model:this.model,value:void 0}},g.prototype.readInTransaction=function(P){var Q=new B;Q.start();var R=this.read(P);return R.reads=Q.stop(),R},g.prototype._read=function(P){var Q=this.model[P];return null==Q?this.parent?this.parent.read(P):void 0:{model:this.model,value:Q}},g.prototype.add=function(P){var Q;return Q=F(P)?P:Array.isArray(P)||'object'==typeof P?E(P):P,new g(Q,this)},j.prototype.getValue=function(P){var Q=this.props()[0];return P.read(Q).value},j.prototype.getStringValue=function(P){for(var S,T,Q=Object.keys(this.values).sort(function(U,V){return+U>+V?1:-1}),R=this.raw;Q.length;)S=Q.pop(),T=P.read(this.values[S]).value,null!=T&&(R=R.substr(0,S)+T+R.substr(S));return R},j.prototype.compute=function(P){var Q=this.includesNonBindings||1<this.count();return Q?this.getStringValue.bind(this,P):this.getValue.bind(this,P)},j.prototype.props=function(){return w(this.values)},j.prototype.count=function(){return!1===this.hasBinding?0:Object.keys(this.values).length},j.prototype.throwIfMultiple=function(P){if(1<this.count())throw P=P||'Only a single binding is allowed in this context.',new Error(P)};var I={attr:function(P,Q){return function(R){P.setAttribute(Q,R)}},text:function(P){return function(Q){P.nodeValue=Q}},prop:function(P,Q){return function(R){P[Q]=R}},event:function(P,Q,R,S,T){var U=S.raw;T.bind(P,Q,function(V){var W=R.read(U);W.value.call(W.model,V)})},each:function(P,Q,R,S){var T=M(P),U=R.props()[0],V=Q.read(U),W=document.createTextNode('');P.parentNode.replaceChild(W,P);var X=function(Z){var $=new Map,aa=new Map,ba=function(ea,fa){var ga=Q.add(ea).add({item:ea,index:fa}),ha=T(ga);S.add(ha);var ia=ha.tree,ja={item:ea,link:ha,nodes:A.call(ia.childNodes),scope:ga,index:fa};$.set(ea,ja),aa.set(fa,ja);var ka=aa.get(fa+1),la=W.parentNode;if(ka){var ma=ka.nodes[0];la.insertBefore(ia,ma)}else la.appendChild(ia)},ca=function(ea){var fa=aa.get(ea);fa&&(fa.nodes.forEach(function(ga){ga.parentNode.removeChild(ga)}),S.remove(fa.link),$.delete(fa.item),aa.delete(ea))};Z.forEach(ba);var da=function(ea,fa){if('delete'===ea.type)return void ca(ea.index);var ga=$.get(fa);if(ga){var ha=ga.index,ia=ha!==ea.index;if(ia){ga.scope.model.index=ga.index=ea.index;var ja=aa.get(ea.index);ja?aa.set(ha,ja):aa.delete(ha),aa.set(ea.index,ga);var ka=aa.get(ea.index+1);ka&&(ka=ka.nodes[0]);for(var la=ga.nodes.length-1;0<=la;)W.parentNode.insertBefore(ga.nodes[la],ka),la--}}else ca(ea.index),ba(fa,ea.index)};return S.on(Z,D,da),function(){for(var ea=0,fa=Z.length;ea<fa;ea++)ca(ea);S.off(Z,D,da),$=null,aa=null}},Y=X(V.value);S.on(V.model,U,function(Z,$){Y(),Y=X($)})},if:function(P,Q,R){var S=M(P),T=!1,U={},V=document.createTextNode('');return P.parentNode.replaceChild(V,P),function(W){if(!!T){var $=V.parentNode,aa=V.nextSibling;W?U.children.forEach(function(ba){$.insertBefore(ba,aa)}):U.children.forEach(function(ba){$.removeChild(ba)})}else if(W){var X=Q.add(W),Y=S(X);R.add(Y);var Z=Y.tree;U.children=A.call(Z.childNodes),U.scope=X,V.parentNode.insertBefore(Z,V.nextSibling),T=!0}}}},J=['if','each'];class K{constructor(){this.map=new Map}set(P,Q,R){let S=this.map.get(P);S||(S=new Map,this.map.set(P,S)),S.set(Q,R)}delete(P,Q){let R=this.map.get(P);R&&R.delete(Q)}}class L{constructor(P){this.tree=P,this.models=new K,this.elements=new K,this.children=[]}loop(P,Q){for(let[R,S]of P)Q(R,S[0],S[1])}on(P,Q,R){this.models.set(P,Q,R),G(P,Q,R)}off(P,Q,R){this.models.delete(P,Q),H(P,Q,R)}bind(P,Q,R){this.elements.set(P,Q,R),P.addEventListener(Q,R)}attach(){this.loop(this.models,G),this.children.forEach(function(P){P.attach()})}detach(){this.loop(this.models,H),this.children.forEach(function(P){P.detach()})}add(P){this.children.push(P)}remove(P){var Q=this.children.indexOf(P);this.children.splice(Q,1)}}var M=function(P){P=P instanceof HTMLTemplateElement?P:document.querySelector(P);var Q=m(P.content,{id:0},{});return function(R){R instanceof g||(R=new g(R));var S=document.importNode(P.content,!0),T=new L(S);return h(T,Q,R),T}},N=q(HTMLElement);q.Element=N,q.model=E,q.on=G,q.off=H,q.template=M;var O='function'==typeof MutationObserver;return q});

